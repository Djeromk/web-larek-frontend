# Проектная работа "Веб-ларек" выполнена по архитектуре MVP

Стек: HTML, SCSS, TS, Webpack

Структура проекта:

- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:

- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/styles/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск

Для установки и запуска проекта необходимо выполнить команды

```bash
npm install
npm run start
```

или

```bash
yarn
yarn start
```

## Сборка

```bash
npm run build
```

или

```bash
yarn build
```

## Бизнес-логика проекта

### 1 Управление каталогом товаров

- Отображение списка товаров.
- Показ детальной информации о каждом товаре по клику в модальном окне.

### 2 Корзина

- Отображение корзины с выбранными позициями.
- Добавление товара в корзину.
- Удаление позиции из корзины.
- Подсчет общей суммы заказа.

### 3 Оформление заказа

- Выбор метода оплаты (наличные или карта).
- Ввод адреса для доставки.
- Ввод контактной информации.
- Проверка на наличие введённых данных.
- Создание и отправка заказа.
- Показ сообщения об успешной оплате.

## Архитектура MVP проекта

### Взаимодействие компонентов

1. Пользователь взаимодействует с View
2. View генерирует события, которые обрабатывает Presenter
3. Presenter обновляет Model
4. Model генерирует события об изменении данных
5. Presenter обрабатывает эти события и обновляет View

#### Класс Api

Содержит в себе базовую логику отправки запросов. В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы:

- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возвращает промис с объектом, которым ответил сервер

- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter

Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.
Основные методы, реализуемые классом описаны интерфейсом `IEvents`:

- `on` - подписка на событие

- `emit` - инициализация события
- `trigger` - возвращает функцию, при вызове которой инициализируется требуемое в параметрах событие


### Модель данных

#### Интерфейсы

• **IProduct** - Для описания данных товара:

```js
interface IProduct {
	id: string;
	description: string;
	image: string;
	title: string;
	category: string;
	price: number | null;
}
```

- **IOrder** - Для описания данных заказа:

```js
interface IOrder {
	payment: 'cash' | 'online';
	email: string;
	phone: string;
	address: string;
	total: number | string;
	items: string[];
}
```

#### Класс данных AppData

Класс **AppData** - это основной класс приложения, который отвечает за хранение и управление данными. Поля класса хранят каталог товаров `catalog: IProduct[]`, объект для формирования заказа `order: Partial<IOrder>` и список ошибок валидации форм `formErrors: Partial<TOrderData>`.

Методы:

- `setCatalog(items: IProduct[]): void` создает каталог товаров, записывает его в поле `catalog` и вызывает событие `items:changed`

- `getBasketCount(): number` - возвращает количество добавленных в корзину товаров
- `addToBasket(item: IProduct): void` - добавляет товар в корзину изменяя его поле `selected`
- `removeFromBasket(id: string): void` - удаляет выбранный в корзине продукт изменяя его поле `selected`
- `getTotalAmount(): number` - возвращает общую стоимость добавленных в корзину продуктов
- `setPaymentData(data: Partial<IOrder>): void` - записывает данные платежа в поле `payment` и вызывает событие `order:changed`
- `setAddress(field: string, value: string): void` - записывает данные покупателя в поле `address` объекта `order` и вызывает событие `order:changed`
- `validateOrder()` - валидирует поля формы заказа с полем ввода адресса и выбора способа оплаты
- `validateContacts()` - валидирует поля формы контактов с полем ввода email и телефона
- `setOrderItems(): void` - записывает список товаров в поле `items` объекта `order`
- `setContacts(field: string, value: string): void` - записывает данные покупателя в поле `phone` и `email` объекта `order`
- `clearCart(): void` - очищает корзину
- `clearOrder(): void` - очищает поле `order`

Этот класс отвечают за бизнес-логику приложения, включают в себя функции управления товарами, корзиной и заказом.

---

#### View

- **Component** - Родительский класс для рендеринга разметки.

```js
render(data: Partial<T>): void,
```

- **Form** - Родительский класс для рендеринга разметки формы. В полях класса содержатся ссылки на все элементы разметки блока, устанавливается слушатели input и submit для формы.
Также использует метод `render` для рендеринга разметки формы.

- **Page** — Класс для рендеринга разметки главной страницы с каталогом товаров и корзиной. В полях класса содержатся ссылки на все элементы разметки блока.:

```js
catalog: IProduct[],
counter: number,
locked: boolean,
```

- **Modal** - Основной класс для реализации модального окна. Предоставляет методы `open` и `close` для управления отображением модального окна. Устанавливает слушатели на клавиатуру, для закрытия модального окна по Esc, на клик в оверлей и кнопку-крестик для закрытия попапа.

```javascript
constructor(container: HTMLElement, events: IEvents)
```

Конструктор принимает контейнер для рендеринга разметки и экземпляр класса `EventEmitter` для возможности инициации событий. Так же имеется сеттер для изменения контента модального окна `set content(value: HTMLElement)` для поля `protected content: HTMLElement;`

```js
open(): void;
close(): void;
render(data: HTMLElement): void,
  ```

  `render(data: HTMLElement): HTMLElement` - позволяет изменить содержимое модального окна.
  `events: IEvents` - привязывает обработчики событий к модальному окну;

Далее следует перечисление классов которые передаются в конструктор класса `Modal`:

- **ProductCard** - Родительский класс для отображения информации о товаре. В конструктор класса передается емиттер для установки слушателей, а так же темплейт карточки.

- **CatalogItem** - Класс для отображения карточки товара. В конструкторе передается темплейт карточки.

- **ProductCardPreview** - Класс для отображения карточки товара в модальном окне. В конструкторе передается темплейт карточки.

- **BasketItem** - Класс для отображения карточки товара в корзине. В конструкторе передается темплейт карточки.

- **Basket** - Класс для отображения содержимого корзины.

```js
basketProducts: HTMLElement // список товаров в корзине
totalAmount: HTMLElement // общая стоимость;
checkoutButton: HTMLElement // кнопка оформления заказа
```

- **Order** - Класс для отображения формы оформления заказа в модальном окне.

```js
adressForm: HTMLFormElement // форма оформления заказа
paymentMethods: HTMLButtonElement // выбор способа оплаты
submit: HTMLButtonElement // кнопка перехода к следующему шагу
```

- **Contacts** - Класс для отображения формы ввода контактных данных в модальном окне.

```js
submit: HTMLButtonElement // кнопка подтверждения заказа
```

- **Success** - Класс для отображения сообщения об успешном оформлении заказа.

```js
description: HTMLElement // сообщение о списании синапсов
confirmButton: HTMLButtonElement // кнопка возвращения на главную страницу
```

---

#### Класс презентера index.ts

Функционал презентера представлен в виде файла `index.ts`. В данном презентере реализованно связывание слоев Model и View.

- Класс `Api` - Принимает в конструктор ссылку на бэкенд и предоставляет методы реализующие взаимодействие с бэкендом сервиса.

---

### Взаимодействие между классами и интерфейсами

Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

#### Главная Страница

При инициализации приложения, ```EventEmitter``` вызывает метод класса `Api`

```js
api.get(API_URL)
```

для получения списка товаров, записи его в ```AppData``` и передачи его в ```Page``` для отображения в разметке.

При клике на товар, ```Page``` передает данные о выбранном товаре в ```EventEmitter```. Presenter вызывает метод модального окна ```Modal.render()``` передавая темплейт модального окна с деталями товара.

#### Добавление товара в корзину

При клике кнопки "В корзину" ```ProductCard``` отправляет событие в Presenter.

- Presenter вызывает метод ```appData.addToBasket(item)```, передавая выбранный товар.

- Presenter обновляет данные корзины, подсчитывая общую сумму и возвращает информацию об обновленной корзине.
- Presenter передает обновленные данные корзины, чтобы обновить модальное окно.

#### Удаление товара из корзины

В проекте реализованно удаление позиции из корзины. По клику на кнопку корзины, Presenter вызывает метод `appData.removeFromBasket(item.id)` который удаляет товар из корзины, обновляет данные, и Presenter передает новые данные для отрисовки корзины.

#### Оформление заказа

При нажатии на кнопку “Оформить” в корзине, пройдут следующие шаги:

- Очищаются пользовательские данные оформлениф заказа `order.clearInput()`

- Presenter передает в `modal.render()` темплейт для открытия модального окна оформления заказа.
- Пользователь заполняет поле адреса и выбирает метод оплаты, Presenter отправляет данные инпута в `appData` проверяет валидность введённого адреса.

- Если данные корректны, Presenter активирует кнопку "Далее" для открытия окна заполнения контактных данных.

- Пользователь вводит email и телефон, после чего данные валидируются, активируется кнопка "Оплатить" и заказ создаётся через методы `appData`.
- После формирования объекта заказа, вызывается `api.post` для отправки заказа на сервер. Presenter вызывает методы для очистки корзины, обновления счетчика товаров на иконке корзины, очищает объект заказа.

- В модальном окне выводится темплейт модального окна об успешной оплате с указанием суммы заказа.

---

#### События EventEmitter

- `items:changed` - событие изменения списка товаров
- `card:select` - событие выбора товара
- `basket:add` - событие добавления в корзину
- `basket:open` - событие открытия корзины
- `basket:remove` - событие удаления из корзины
- `basket:order` - событие оформления заказа
- `formErrors:address` - событие валидации адреса
- `formErrors:contacts` - событие валидации контактов
- `order:togglePayment` - событие переключения метода оплаты
- `order:addressInput` - событие ввода адреса
- `order:submit` - событие оформления заказа
- `order:success` - событие успешного оформления заказа
- `contacts:input` - событие ввода контактных данных
- `contacts:submit` - событие отправки контактных данных заказа
